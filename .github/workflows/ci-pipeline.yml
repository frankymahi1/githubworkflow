name: Complex CI/CD Demo

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select the environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:

  prepare:
    name: ğŸ› ï¸ Preparation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up environment variables
        run: |
          echo "ENV=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          echo "Setting up environment variables for ${{ github.event.inputs.environment }}"

  build:
    name: ğŸ—ï¸ Build Matrix
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        java: [11, 17]
    steps:
      - name: Print Build Info
        run: |
          echo "Building on OS=${{ matrix.os }} with Java=${{ matrix.java }}"
          sleep 5  # Simulate build time

  test:
    name: ğŸ§ª Test & Coverage
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Run Unit Tests
        run: |
          echo "Running unit tests..."
          sleep 3

      - name: Run Integration Tests
        if: ${{ github.event.inputs.environment == 'staging' }}
        run: |
          echo "Running integration tests (only on staging)..."
          sleep 3

  security:
    name: ğŸ” Security Checks
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Run Static Code Analysis
        run: |
          echo "Analyzing code..."
          sleep 2

      - name: Run Vulnerability Scan
        run: |
          echo "Scanning dependencies..."
          sleep 2

  deploy:
    name: ğŸš€ Deploy to ${{ github.event.inputs.environment }}
    needs: [security]
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Deploy
        run: |
          echo "Deploying to ${{ github.event.inputs.environment }}..."
          sleep 4

      - name: Notify Slack
        run: |
          echo "Notify Slack (simulated)"